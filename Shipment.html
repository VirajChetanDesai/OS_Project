<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shipping Management with Deadlock Detection</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #1c1c1c;
            color: white;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 40px);
            margin: 0;
        }

        form {
            background: #333;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
            width: 60%;
            max-width: 500px;
        }

        h1, h2, h3 {
            text-align: center;
            color: #0d6efd;
        }

        label {
            color: #0d6efd;
            display: block;
            margin: 10px 0 5px;
        }

        input, select, button {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            border: none;
            box-sizing: border-box;
        }

        input[type="submit"], button {
            background-color: #0d6efd;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        input[type="submit"]:hover, button:hover {
            background-color: #0b5ed7;
        }

        input[type="submit"]:active, button:active {
            background-color: #0a58ca;
        }

        #alertBox {
            margin-top: 20px;
            padding: 20px;
            background-color: #f44336;
            color: white;
            display: none;
            text-align: center;
            border-radius: 5px;
        }

        #mynetwork {
            width: 100%;
            height: 400px;
            border: 1px solid lightgray;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <h1>Shipping Management System</h1>
    <!-- Add Product Section -->
    <div>
        <label for="newProductId">Add New Product:</label>
        <input type="text" id="newProductId" placeholder="Enter product ID" />
        <button onclick="addProduct()">Add Product</button>
    </div>

    <!-- Add Ship Section -->
    <div>
        <label for="newShipId">Add New Ship:</label>
        <input type="text" id="newShipId" placeholder="Enter ship ID" />
        <button onclick="addShip()">Add Ship</button>
    </div>

    <!-- Relationship Assignment Section -->
    <div>
        <h3>Assign Relationship:</h3>
        <label for="fromSelection">From:</label>
        <select id="fromSelection"></select>

        <label for="toSelection">To:</label>
        <select id="toSelection"></select>

        <button onclick="assignRelationship()">Assign Relationship</button>
        <button onclick="simulateDeadlock()">Simulate Deadlock</button>
    </div>

    <div id="alertBox"></div>
    <div id="waitingArea">
        <h3>Waiting Queue</h3>
        <ul id="waitingList"></ul>
    </div>
    <div id="shipArea">
        <h3>Ship Availability</h3>
        <ul id="shipList"></ul>
    </div>
    <div id="mynetwork"></div>
    <!-- The script will be provided in the next cell -->
</body>
</html>

    <script>
    // Globals to maintain state
    var products = [];
    var ships = {};
    var nodes = new vis.DataSet([]);
    var edges = new vis.DataSet([]);
    var container = document.getElementById('mynetwork');
    var data = { nodes: nodes, edges: edges };
    var options = {
        autoResize: true,
        height: '400px',
        width: '100%',
        layout: {
            hierarchical: {
                enabled: true,
                levelSeparation: 150,
                nodeSpacing: 100,
                treeSpacing: 200,
                blockShifting: true,
                edgeMinimization: true,
                parentCentralization: true,
                direction: 'UD',        // UD, DU, LR, RL
                sortMethod: 'directed'  // hubsize, directed
            }
        },
        physics: {
            hierarchicalRepulsion: {
                centralGravity: 0.0,
                springLength: 100,
                springConstant: 0.01,
                nodeDistance: 120,
                damping: 0.09
            }
        },
        nodes: {
            shape: 'dot',
            size: 20
        },
        edges: {
            smooth: true,
            arrows: { to: true }
        }
    };
    var network = new vis.Network(container, data, options);

    // Function to add a product to the system
    function addProductManually(productId) {
        if (!productId || products.includes(productId)) {
            showAlert('Product ID is invalid or already exists.');
            return;
        }
        products.push(productId);
        nodes.add({ id: productId, label: `Product ${productId}`, group: 'product', level: 2 });
        updateDropdowns();
        showAlert(`Product ${productId} added.`);
    }

    // Function to add a ship to the system
    function addShipManually(shipId) {
        if (!shipId || ships[shipId]) {
            showAlert('Ship ID is invalid or already exists.');
            return;
        }
        ships[shipId] = { 'instances': 1, 'available': 1 };  // Assuming each ship has 1 instance for simplicity
        nodes.add({ id: shipId, label: `Ship ${shipId}`, group: 'ship', level: 1 });
        updateDropdowns();
        showAlert(`Ship ${shipId} added.`);
    }

    // Function to assign a relationship between entities
    function assignRelationship() {
        var fromId = document.getElementById('fromSelection').value;
        var toId = document.getElementById('toSelection').value;

        if (!fromId || !toId || fromId === toId) {
            showAlert('Invalid relationship. Cannot assign same or empty entities.');
            return;
        }
        edges.add({ from: fromId, to: toId });
        if (detectDeadlock()) {
            resolveDeadlock();
        }
        showAlert(`Relationship assigned from ${fromId} to ${toId}`);
    }

    // Function to update the dropdowns with the current products and ships
    function updateDropdowns() {
        var fromSelection = document.getElementById('fromSelection');
        var toSelection = document.getElementById('toSelection');

        fromSelection.innerHTML = '';
        toSelection.innerHTML = '';

        Object.keys(ships).forEach(shipId => {
            fromSelection.innerHTML += `<option value="${shipId}">${shipId}</option>`;
        });
        products.forEach(productId => {
            toSelection.innerHTML += `<option value="${productId}">${productId}</option>`;
        });
    }

    // Function to detect a cycle in the graph using Depth-First Search (DFS)
    function detectCycle(node, visited, recStack, graph) {
        if (!visited[node]) {
            visited[node] = true;
            recStack[node] = true;

            var nodeEdges = graph.get({
                filter: function (item) {
                    return item.from === node;
                }
            });

            for (var edgeIdx in nodeEdges) {
                var currentNode = nodeEdges[edgeIdx].to;
                if (!visited[currentNode] && detectCycle(currentNode, visited, recStack, graph)) {
                    return true;
                } else if (recStack[currentNode]) {
                    return true;
                }
            }
        }
        recStack[node] = false;
        return false;
    }

    // Deadlock detection function
    function detectDeadlock() {
        var visited = {};
        var recStack = {};
        products.concat(Object.keys(ships)).forEach(node => {
            visited[node] = false;
            recStack[node] = false;
        });

        for (var node in visited) {
            if (detectCycle(node, visited, recStack, edges)) {
                showAlert('Deadlock detected!');
                return true;
            }
        }
        showAlert('No deadlock detected.');
        return false;
    }

    // Deadlock resolution function
    function resolveDeadlock() {
        var cycles = [];
        var visited = {};
        var recStack = {};
        products.concat(Object.keys(ships)).forEach(node => {
            visited[node] = false;
            recStack[node] = false;
        });

        for (var node in visited) {
            if (detectCycle(node, visited, recStack, edges)) {
                cycles.push(node);
            }
        }

        if (cycles.length > 0) {
            // For simplicity, we'll just remove the first edge of the first cycle we found
            var cycleEdges = edges.get({
                filter: function (item) {
                    return item.from === cycles[0] || item.to === cycles[0];
                }
            });

            if (cycleEdges.length > 0) {
                edges.remove(cycleEdges[0].id);
                showAlert('Deadlock resolved by removing a relationship.');
            }
        } else {
            showAlert('No deadlock to resolve.');
        }
    }

    // Function to simulate a deadlock scenario for demonstration purposes
    function simulateDeadlock() {
        clearSimulation();
        // Add some products and ships
        addProductManually('P1');
        addProductManually('P2');
        addShipManually('S1');
        addShipManually('S2');
        // Create a circular relationship to simulate deadlock
        assignRelationship('P1', 'S1');
        assignRelationship('S1', 'P2');
        assignRelationship('P2', 'S2');
        assignRelationship('S2', 'P1');
    }

    // Function to clear the simulation and reset the system
    function clearSimulation() {
        products = [];
        ships = {};
        nodes.clear();
        edges.clear();
        updateDropdowns();
        showAlert('Simulation cleared.');
    }

    // Function to show alert messages
    function showAlert(message) {
        const alertBox = document.getElementById('alertBox');
        alertBox.style.display = 'block';
        alertBox.textContent = message;
        setTimeout(() => {
            alertBox.style.display = 'none';
        }, 5000);
    }

    // Initial dropdown update
    updateDropdowns();
    </script>
</body>
</html>
